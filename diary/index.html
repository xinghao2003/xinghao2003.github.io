<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Timeline Diary</title>
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#111827">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Timeline Diary">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        :root {
            --bg: #ffffff;
            --text: #0f172a;
            --muted: #64748b;
            --border: #e2e8f0;
            --card: #ffffff;
            --accent: #111827;
            --accent-contrast: #ffffff;
            --shadow: 0 1px 2px rgba(0, 0, 0, .06);
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --bg: #0b1020;
                --text: #e5e7eb;
                --muted: #94a3b8;
                --border: #111827;
                --card: #0e152b;
                --accent: #e5e7eb;
                --accent-contrast: #0b1020;
                --shadow: 0 1px 2px rgba(0, 0, 0, .25);
            }
        }

        * {
            box-sizing: border-box;
        }

        html,
        body {
            height: 100%;
        }

        body {
            margin: 0;
            font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
            background: var(--bg);
            color: var(--text);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Added for hidden utility */
        .hidden {
            display: none !important;
        }

        .app {
            max-width: 800px;
            margin: 0 auto;
            padding: env(safe-area-inset-top) 16px calc(88px + env(safe-area-inset-bottom));
            min-height: 100dvh;
            transition: padding .2s ease;
        }

        .appbar {
            position: sticky;
            top: 0;
            background: var(--bg);
            z-index: 10;
            padding: 16px 0 8px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
        }

        .title {
            font-size: 18px;
            font-weight: 700;
            letter-spacing: .2px;
        }

        .actions {
            display: flex;
            gap: 8px;
        }

        .icon-btn {
            appearance: none;
            border: 1px solid var(--border);
            background: var(--card);
            color: var(--text);
            padding: 8px 12px;
            border-radius: 10px;
            cursor: pointer;
            box-shadow: var(--shadow);
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
        }

        .hint {
            color: var(--muted);
            font-size: 12px;
            margin-top: 4px;
        }

        .day {
            position: sticky;
            top: 56px;
            background: var(--bg);
            padding: 10px 0 6px;
            z-index: 1;
            color: var(--muted);
            font-size: 12px;
            letter-spacing: .3px;
            text-transform: uppercase;
        }

        .entry {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 14px;
            margin-bottom: 12px;
            box-shadow: var(--shadow);
        }

        .entry .meta {
            color: var(--muted);
            font-size: 12px;
            margin-bottom: 6px;
        }

        .entry .text {
            font-size: 15px;
            line-height: 1.5;
            white-space: pre-wrap;
        }

        .entry img {
            width: 100%;
            max-width: 420px;
            border-radius: 10px;
            display: block;
            margin-top: 10px;
        }

        .empty {
            text-align: center;
            color: var(--muted);
            margin-top: 20vh;
        }

        .composer {
            position: fixed;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 40;
            background: var(--bg);
            border-top: 1px solid var(--border);
        }

        .composer-inner {
            max-width: 800px;
            margin: 0 auto;
            padding: 10px 16px calc(10px + env(safe-area-inset-bottom));
            display: grid;
            grid-template-columns: auto 1fr auto;
            gap: 8px;
            align-items: end;
        }

        .camera {
            appearance: none;
            border: 1px solid var(--border);
            background: var(--card);
            color: var(--text);
            height: 40px;
            width: 40px;
            border-radius: 10px;
            cursor: pointer;
            box-shadow: var(--shadow);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .input {
            width: 100%;
            border: 1px solid var(--border);
            background: var(--card);
            color: var(--text);
            border-radius: 12px;
            padding: 10px 12px;
            font-size: 15px;
            resize: none;
            min-height: 40px;
            max-height: 32dvh;
            box-shadow: var(--shadow);
        }

        .primary {
            appearance: none;
            border: none;
            background: var(--accent);
            color: var(--accent-contrast);
            border-radius: 12px;
            height: 40px;
            padding: 0 14px;
            font-weight: 700;
            cursor: pointer;
            opacity: 1;
            transition: opacity .15s ease;
        }

        .primary:disabled {
            opacity: .35;
            cursor: not-allowed;
        }

        .preview {
            grid-column: 1 / -1;
            display: flex;
            gap: 8px;
            align-items: center;
            padding: 0 2px;
            margin-top: 6px;
        }

        .thumb {
            height: 44px;
            width: 44px;
            border-radius: 8px;
            object-fit: cover;
            border: 1px solid var(--border);
        }

        .pill {
            border: 1px solid var(--border);
            color: var(--muted);
            background: var(--card);
            padding: 6px 10px;
            border-radius: 999px;
            font-size: 12px;
        }

        .link {
            color: inherit;
            text-decoration: none;
            border-bottom: 1px dotted var(--border);
        }

        .x {
            background: transparent;
            border: 0;
            color: var(--muted);
            cursor: pointer;
            font-size: 18px;
            line-height: 1;
            padding: 4px;
        }

        .toast {
            position: fixed;
            left: 50%;
            transform: translateX(-50%);
            bottom: 88px;
            background: var(--card);
            color: var(--text);
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
            padding: 8px 12px;
            border-radius: 10px;
            display: none;
            z-index: 50;
        }

        .toast.show {
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .install {
            position: fixed;
            bottom: calc(88px + 12px);
            left: 50%;
            transform: translateX(-50%);
            background: var(--card);
            border: 1px solid var(--border);
            box-shadow: var(--shadow);
            padding: 10px 12px;
            border-radius: 12px;
            display: none;
            gap: 8px;
            align-items: center;
        }

        .install.show {
            display: inline-flex;
        }

        .install .btn {
            appearance: none;
            border: 1px solid var(--border);
            background: var(--bg);
            padding: 6px 10px;
            border-radius: 8px;
            cursor: pointer;
        }
    </style>
</head>

<body>
    <div class="app">
        <header class="appbar">
            <div class="title">Diary</div>
            <div class="actions">
                <button class="icon-btn" id="exportBtn">💾 Export</button>
            </div>
        </header>

        <div id="timeline">
            <div class="empty" id="emptyState">No entries yet. Write something below. Press Enter to save.</div>
        </div>
    </div>

    <div class="composer" id="composer">
        <div class="composer-inner" id="dropZone">
            <button class="camera" id="cameraBtn" title="Add photo">📷</button>
            <input type="file" id="imageInput" accept="image/*" capture="environment" class="hidden" />
            <textarea class="input" id="textInput" placeholder="Write a thought… Enter to save. Shift+Enter = newline"
                rows="1"></textarea>
            <button class="primary" id="addBtn" disabled>Add</button>
            <div class="preview hidden" id="preview">
                <img id="thumb" class="thumb" alt="preview" />
                <span class="pill">Photo attached</span>
                <button class="x" id="clearImage" title="Remove">×</button>
            </div>
        </div>
    </div>

    <div class="toast" id="netToast"></div>
    <div class="install" id="installPrompt">
        <span>Install Diary?</span>
        <button class="btn" id="installBtn">Install</button>
        <button class="btn" id="closeInstallBtn">Dismiss</button>
    </div>

    <script>
        // State
        let diaryEntries = [];
        let imageStorage = {};
        let currentImageData = null;
        let currentImageFilename = null;

        // Elements
        const textInput = document.getElementById('textInput');
        const addBtn = document.getElementById('addBtn');
        const exportBtn = document.getElementById('exportBtn');
        const timeline = document.getElementById('timeline');
        const emptyState = document.getElementById('emptyState');
        const cameraBtn = document.getElementById('cameraBtn');
        const imageInput = document.getElementById('imageInput');
        const preview = document.getElementById('preview');
        const thumb = document.getElementById('thumb');
        const clearImage = document.getElementById('clearImage');
        const dropZone = document.getElementById('dropZone');

        // PWA / Network UI
        const installPrompt = document.getElementById('installPrompt');
        const installBtn = document.getElementById('installBtn');
        const closeInstallBtn = document.getElementById('closeInstallBtn');
        const netToast = document.getElementById('netToast');

        // Utils
        function saveEntriesToStorage() {
            try {
                localStorage.setItem('diaryEntries', JSON.stringify(diaryEntries));
                localStorage.setItem('imageStorage', JSON.stringify(imageStorage));
            } catch (e) { console.error(e); }
        }
        function loadEntriesFromStorage() {
            try {
                const saved = localStorage.getItem('diaryEntries');
                if (saved) diaryEntries = JSON.parse(saved);
                const savedImages = localStorage.getItem('imageStorage');
                if (savedImages) imageStorage = JSON.parse(savedImages);
            } catch (e) {
                console.error(e); diaryEntries = []; imageStorage = {};
            }
        }
        function generateImageFilename(ts) {
            const d = new Date(ts);
            const date = d.toISOString().slice(0, 10);
            const time = d.toTimeString().slice(0, 8).replace(/:/g, '-');
            return `diary-${date}-${time}.jpg`;
        }
        function formatDayLabel(d) {
            const today = new Date();
            const day = new Date(d.getFullYear(), d.getMonth(), d.getDate());
            const t = new Date(today.getFullYear(), today.getMonth(), today.getDate());
            const diff = Math.round((t - day) / 86400000);
            if (diff === 0) return 'Today';
            if (diff === 1) return 'Yesterday';
            return d.toLocaleDateString(undefined, { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' });
        }

        // Composer behaviors
        function updateAddEnabled() {
            const hasText = textInput.value.trim().length > 0;
            addBtn.disabled = !(hasText || currentImageData);
        }
        textInput.addEventListener('input', () => {
            textInput.style.height = 'auto';
            textInput.style.height = Math.min(textInput.scrollHeight, window.innerHeight * 0.32) + 'px';
            updateAddEnabled();
        });
        textInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                tryAddEntry();
            }
        });

        addBtn.addEventListener('click', tryAddEntry);

        function setPreview(dataUrl) {
            currentImageData = dataUrl;
            currentImageFilename = generateImageFilename(Date.now());
            thumb.src = dataUrl;
            preview.classList.remove('hidden');
            updateAddEnabled();
        }
        function clearPreview() {
            currentImageData = null;
            currentImageFilename = null;
            preview.classList.add('hidden');
            thumb.removeAttribute('src');
            updateAddEnabled();
        }
        clearImage.addEventListener('click', clearPreview);

        // Image input (native camera / picker)
        cameraBtn.addEventListener('click', () => imageInput.click());
        imageInput.addEventListener('change', (e) => {
            const file = e.target.files && e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = () => setPreview(reader.result);
            reader.readAsDataURL(file);
            imageInput.value = '';
        });

        // Paste image support
        document.addEventListener('paste', (e) => {
            if (!e.clipboardData) return;
            const file = Array.from(e.clipboardData.items || [])
                .filter(i => i.kind === 'file')
                .map(i => i.getAsFile())
                .find(f => !!f && f.type.startsWith('image/'));
            if (file) {
                const reader = new FileReader();
                reader.onload = () => setPreview(reader.result);
                reader.readAsDataURL(file);
            }
        });

        // Drag & drop image
        ;['dragenter', 'dragover'].forEach(evt => dropZone.addEventListener(evt, (e) => { e.preventDefault(); e.dataTransfer.dropEffect = 'copy'; }));
        ;['dragleave', 'drop'].forEach(evt => dropZone.addEventListener(evt, (e) => { e.preventDefault(); }));
        dropZone.addEventListener('drop', (e) => {
            const file = (e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files[0]) || null;
            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = () => setPreview(reader.result);
                reader.readAsDataURL(file);
            }
        });

        function tryAddEntry() {
            const text = textInput.value.trim();
            if (!text && !currentImageData) return;

            const id = Date.now();
            const timestamp = new Date().toISOString();
            const entry = { id, text, imageFilename: currentImageFilename, timestamp };
            if (currentImageData && currentImageFilename) {
                imageStorage[currentImageFilename] = currentImageData;
            }
            diaryEntries.unshift(entry);
            saveEntriesToStorage();
            renderTimeline();

            // reset
            textInput.value = '';
            textInput.style.height = '40px';
            clearPreview();
        }

        // Export
        exportBtn.addEventListener('click', async () => {
            if (!diaryEntries.length) return;
            exportBtn.disabled = true; const old = exportBtn.textContent; exportBtn.textContent = '⏳ Exporting…';
            try {
                const zip = new JSZip();
                const data = {
                    exportDate: new Date().toISOString(),
                    totalEntries: diaryEntries.length,
                    version: '2.0',
                    entries: diaryEntries.map(e => ({ id: e.id, text: e.text, imageFilename: e.imageFilename || null, timestamp: e.timestamp }))
                };
                zip.file('diary-data.json', JSON.stringify(data, null, 2));
                const images = zip.folder('images');
                for (const e of diaryEntries) {
                    if (e.imageFilename && imageStorage[e.imageFilename]) {
                        const base64 = imageStorage[e.imageFilename].split(',')[1];
                        images.file(e.imageFilename, base64, { base64: true });
                    }
                }
                const content = await zip.generateAsync({ type: 'blob' });
                const url = URL.createObjectURL(content);
                const a = document.createElement('a');
                a.href = url; a.download = `diary-export-${new Date().toISOString().slice(0, 10)}.zip`; a.click();
                URL.revokeObjectURL(url);
            } catch (e) { console.error(e); }
            finally { exportBtn.textContent = old; exportBtn.disabled = false; }
        });

        // Render timeline (group by day)
        function renderTimeline() {
            if (!diaryEntries.length) {
                timeline.innerHTML = '<div class="empty" id="emptyState">No entries yet. Write something below. Press Enter to save.</div>';
                return;
            }

            const groups = new Map();
            for (const e of diaryEntries) {
                const d = new Date(e.timestamp);
                const key = d.toISOString().slice(0, 10);
                if (!groups.has(key)) groups.set(key, { date: d, items: [] });
                groups.get(key).items.push(e);
            }

            const html = Array.from(groups.entries())
                .sort((a, b) => b[0].localeCompare(a[0]))
                .map(([key, g]) => {
                    const dayLabel = formatDayLabel(g.date);
                    const items = g.items.map(e => {
                        const imageTag = e.imageFilename && imageStorage[e.imageFilename]
                            ? `<img src="${imageStorage[e.imageFilename]}" alt="Photo">`
                            : '';
                        const time = new Date(e.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                        const text = e.text ? `<div class="text">${escapeHtml(e.text)}</div>` : '';
                        return `<article class="entry"><div class="meta">${time}</div>${text}${imageTag}</article>`;
                    }).join('');
                    return `<section class="day"><div>${dayLabel}</div></section>${items}`;
                }).join('');

            timeline.innerHTML = html;
        }

        function escapeHtml(str) {
            return str
                .replaceAll('&', '&amp;')
                .replaceAll('<', '&lt;')
                .replaceAll('>', '&gt;')
                .replaceAll('"', '&quot;')
                .replaceAll("'", '&#039;');
        }

        // Network status toast
        let online = navigator.onLine;
        function showToast(text) {
            netToast.textContent = text; netToast.classList.add('show');
            setTimeout(() => netToast.classList.remove('show'), 2500);
        }
        function updateOnlineStatus() {
            if (navigator.onLine && !online) showToast('Back online');
            if (!navigator.onLine && online) showToast('You\'re offline');
            online = navigator.onLine;
        }
        window.addEventListener('online', updateOnlineStatus);
        window.addEventListener('offline', updateOnlineStatus);

        // PWA install
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault(); deferredPrompt = e;
            if (!window.matchMedia('(display-mode: standalone)').matches) installPrompt.classList.add('show');
        });
        installBtn.addEventListener('click', async () => {
            if (!deferredPrompt) return;
            deferredPrompt.prompt(); await deferredPrompt.userChoice; deferredPrompt = null; installPrompt.classList.remove('show');
        });
        closeInstallBtn.addEventListener('click', () => installPrompt.classList.remove('show'));

        // Service Worker registration with aggressive update activation
        if ('serviceWorker' in navigator) {
            const reloadOnce = () => {
                if (sessionStorage.getItem('sw-reloaded')) return;
                sessionStorage.setItem('sw-reloaded', '1');
                location.reload();
            };
            navigator.serviceWorker.addEventListener('controllerchange', reloadOnce);
            navigator.serviceWorker.register('./sw.js').then(reg => {
                // If there's an updated worker waiting, ask it to activate
                if (reg.waiting) {
                    reg.waiting.postMessage({ type: 'SKIP_WAITING' });
                }
                reg.addEventListener('updatefound', () => {
                    const newSW = reg.installing;
                    if (!newSW) return;
                    newSW.addEventListener('statechange', () => {
                        if (newSW.state === 'installed' && navigator.serviceWorker.controller) {
                            // New content available, trigger a one-time reload
                            reloadOnce();
                        }
                    });
                });
            }).catch(console.warn);
        }

        // Init
        loadEntriesFromStorage();
        renderTimeline();
        updateOnlineStatus();
        updateAddEnabled();
    </script>
</body>

</html>